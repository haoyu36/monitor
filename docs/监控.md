> 监控是为了保障业务持续、稳定、安全的运行

# 一：监控

## 1.1 概念

> 监控 (monitoring) 指收集、处理、汇总，并且显示关于某个系统的实时量化数据，如请求的数量和类型、业务的转化率等等

一个好的监控系统，不仅可以实时暴露系统的各种问题，更可以根据这些监控到的状态，自动分析和定位大致的瓶颈来源

## 1.2 监控分层

监控分为系统层，应用层，业务层

![1585058674](http://pic.haoyu95.cn/uploads/big/afb65ffb0af08b4ae44265369dee13ee.png)


### 系统层

从系统来说，监控系统要涵盖系统的整体资源使用情况，如 CPU、内存、磁盘和文件系统、网络等各种系统资源。通过监控技术环境状况，帮助检测、诊断和解决技术环境中的故障和问题

### 应用层

从应用程序来说，监控系统要涵盖应用程序内部的运行状态，这既包括进程的 CPU、磁盘 I/O 等整体运行状况，更需要包括诸如接口调用耗时、执行过程中的错误、内部对象的内存使用等应用程序内部的运行状况

### 业务层

> 监控系统是为了支持业务，并确保业务持续开展

监控将系统和应用程序生成的指标转换为对应的业务指标，监控系统会将指标转换为衡量用户体验的依据，该依据为业务提供反馈，以确保为客户提供所需的产品。同时该依据还提供了对技术的反馈，指出哪些组件不起作用或者导致服务质量下降

如果无法从业务指标开始，则可以试着从靠近用户测的地方监控。因为他们才是最终的客户，他们的体验是推动业务发展的动力，了解他们的体验并发现他们何时遇到问题本身就很有价值


## 1.3 tips

- 应该分析一段时间内数据的变化，而不是一个时间点的数值
- 监控系统的实施和部署应该自动化，应该花费更多的时间在监控上而不是维护监控系统
- 监控系统应该解决两个问题：什么东西出故障了，以及为什么出故障。“什么东西出故障了”即为现象，“为什么”则代表了原因


# 二：监控方法

## 2.1 USE 方法

> USE 指标侧重于主机监控，直接表明了系统的资源瓶颈

USE 是使用率 (Utilization)、饱和度 (Saturation) 和错误 (Error) 的缩写

- 使用率: 表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务
- 饱和度: 表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求
- 错误数: 表示发生错误的事件个数。错误数越多，表明系统的问题越严重

- [The USE Method](http://brendangregg.com/usemethod.html)

## 2.2 Google 的四个黄金指标

Google 四个黄金指标，侧重于应用程序性能的监控

- 延迟：服务请求所需耗时（如 HTTP 请求平均延时）
- 流量/吞吐：衡量服务容量需求（如每秒处理 HTTP 请求数）
- 错误：衡量错误发生情况（如 HTTP 500 错误数）
- 饱和度：衡量资源使用情况（CPU/内存/磁盘使用情况）

## 2.3 黑盒与白盒

白盒监控：依靠系统内部暴露的一些性能指标进行监控，如日志分析

黑盒监控：通过测试某种外部用户可见的系统行为进行监控

黑盒监控是面向现象的，代表目前正在发生的——而非预测会发生的问题，即系统现在有故障。白盒监控则大量依赖对系统内部信息的检测，如系统日志，白盒监控因此可以检测到即将发生的问题以及那些重试所掩盖的问题


# 三：监控系统

## 3.1 监控方式

- logging: 日志输入，离散的事件
- Tracing：链路追踪
- Metrics： 时间序列的数值，可聚合

- [1585359921](http://pic.haoyu95.cn/uploads/big/11f9595d40875cfdf211702f8384b2a5.png)

当出现问题时，Metrics 可以第一时间响应并告警，logging 和 Metrics 可以调试发现问题

- [Go for Industrial Programming](https://peter.bourgon.org/go-for-industrial-programming/)


# 四：报警

报警可以为我们提供一些指示，表明环境中的某些状态已经发生变化。一个好的警报的关键是能够在正确的时间、以正确的理由和正确的速度发送，并在其中放入有用的信息

一个高效的警报系统应该提供足够的信息，并且误报率非常低。一定不要频繁发送大量的警报，报警过多时可能会忽略掉真实发生的故障

通知系统：

- 哪些问题需要通知
- 谁需要被告知
- 如何告知他们
- 多久告知一次
- 何时停止告知以及何时升级到其他人

一个合格的报警通知应该包含以下部分：

- 报警级别
- 简短的报警名称
- 简要说明
- 详细说明
- 附加上下文信息
- 一个链接，点击后进入指标的 Graph


# 五：参考资料

- [创业公司如何快速构建高效的监控系统？](https://www.jianshu.com/p/db8b70e0bb44)
- [海量监控体系是如何炼成的？(腾讯运维总监聂鑫)](https://www.jianshu.com/p/8a1b426eff71)
- [关于容器迁移、运维、查错与监控，你想知道的都在这里了](https://developer.aliyun.com/article/719818)
- [面试装逼系列｜这篇文章，让运维监控不再成为你的短板!](https://segmentfault.com/a/1190000020990098)
- [运维必知必会的监控知识体系全梳理](http://www.ciotimes.com/Infrastructure/166668.html)
- [监控体系建设（完整）](http://www.yunweipai.com/archives/15189.html)
- [转载|一张思维导图，包罗最全监控体系建设要点！](https://www.jianshu.com/p/cb655afedc98)
- [分级告警策略，人性化系统监控？](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651960843&idx=1&sn=dcbb3d84f413b95fff4628c06da12003&chksm=bd2d03d78a5a8ac15be0757d923b7ccd34307958f0a49fa2fdbd55f1d1548be401fe42e831a9&scene=21#wechat_redirect)
